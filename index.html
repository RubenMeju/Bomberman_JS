<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bomberman JS Game</title>
  </head>

  <style>
    canvas {
      background-color: green;
      border: 10px solid gray;
    }
  </style>
  <body>
    <canvas id="gameCanvas"></canvas>
  </body>

  <script>
    // Definir el mapLevel1
    // 1 = Muro
    // 2 = Bloque rompible
    // 3 = Jugador
    let map = [
      [
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1,
      ],

      [
        1, 0, 0, 0, 0, 0, 2, 2, 2, 0, 0, 2, 2, 0, 0, 2, 2, 0, 0, 0, 2, 0, 0, 0,
        0,
      ],

      [
        1, 0, 1, 0, 1, 0, 1, 2, 1, 2, 1, 0, 1, 0, 1, 2, 1, 0, 1, 2, 1, 2, 1, 2,
        1,
      ],
      [
        1, 0, 0, 0, 2, 2, 2, 0, 0, 0, 0, 2, 2, 0, 0, 0, 0, 0, 2, 2, 0, 2, 0, 2,
        2,
      ],
      [
        1, 0, 1, 0, 1, 2, 1, 0, 1, 2, 1, 0, 1, 0, 1, 0, 1, 2, 1, 0, 1, 0, 1, 2,
        1,
      ],
      [
        1, 0, 0, 0, 0, 0, 2, 2, 0, 2, 2, 0, 2, 0, 2, 0, 2, 0, 0, 0, 0, 0, 2, 0,
        0,
      ],
      [
        1, 0, 1, 0, 1, 0, 1, 0, 1, 2, 1, 0, 1, 2, 1, 2, 1, 0, 1, 0, 1, 2, 1, 0,
        1,
      ],
      [
        1, 2, 0, 0, 2, 2, 0, 0, 2, 2, 0, 2, 2, 0, 0, 0, 0, 0, 2, 0, 2, 0, 0, 0,
        2,
      ],
      [
        1, 0, 1, 2, 1, 2, 1, 0, 1, 2, 1, 2, 1, 0, 1, 2, 1, 0, 1, 0, 1, 0, 1, 2,
        1,
      ],
      [
        1, 0, 2, 0, 2, 0, 2, 0, 0, 0, 2, 0, 2, 0, 2, 0, 0, 0, 0, 2, 2, 0, 0, 2,
        2,
      ],
      [
        1, 2, 1, 0, 1, 0, 1, 2, 1, 2, 1, 0, 1, 2, 1, 0, 1, 2, 1, 2, 1, 0, 1, 2,
        1,
      ],
      [
        1, 2, 2, 2, 0, 0, 0, 0, 2, 0, 0, 0, 2, 0, 0, 2, 2, 0, 0, 0, 0, 0, 2, 2,
        2,
      ],
      [
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1,
      ],
    ];

    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    // Ancho y alto del canvas
    canvas.width = 1050;
    canvas.height = 545;

    // Crear una nueva imagen para el sprite sheet
    var spriteSheet = new Image();
    spriteSheet.src = "./sprites.png";

    /* VARIABLES DEL JUGADOR */
    const PLAYER_SENSITIVITY = 3;

    const playerHeight = 32;
    const playerWidth = 32;

    //posición del jugador
    let playerX = 42;
    let playerY = 42;

    // VARIABLES MOVIMIENTO DEL JUGADOR
    let rightPressed = false;
    let leftPressed = false;
    let upPressed = false;
    let downPressed = false;

    // Tamaño de cada celda en el mapa
    var cellSize = 42; // Tamaño de cada sprite en el sprite sheet
    //DIBUJAR EL MAPA
    function drawMap() {
      // Iterar sobre cada celda del mapa
      for (var i = 0; i < map.length; i++) {
        for (var j = 0; j < map[i].length; j++) {
          // Si el valor de la celda es 1 (pared), dibujar el sprite de la pared
          if (map[i][j] === 1) {
            // Calcular las coordenadas de dibujo en el canvas
            var x = j * cellSize;
            var y = i * cellSize;

            // Dibujar el sprite de la pared en el canvas
            ctx.drawImage(
              spriteSheet,
              48,
              48,
              15, // el tamaño del recorte
              15, // el tamaño del recorte
              x, // posición X del dibujo
              y, // posición X del dibujo
              cellSize, // ancho del dibujo
              cellSize // ancho del dibujo
            );
          } else if (map[i][j] === 2) {
            // Calcular las coordenadas de dibujo en el canvas
            var x = j * cellSize;
            var y = i * cellSize;

            // Dibujar el otro sprite en el canvas (cuando el valor de la celda es 2)
            ctx.drawImage(
              spriteSheet,
              64,
              48,
              15, // el tamaño del recorte
              15, // el tamaño del recorte
              x, // posición X del dibujo
              y, // posición X del dibujo
              cellSize, // ancho del dibujo
              cellSize // ancho del dibujo
            );
          }
        }
      }
    }

    // DIBUJAR EL JUGADOR
    function drawPlayer() {
      //Dibujar el jugador
      ctx.drawImage(
        spriteSheet,
        0,
        0,
        13, // el tamaño del recorte
        15, // tamaño del recorte
        playerX, // posición X del dibujo
        playerY, // posición Y del dibujo
        32, // ancho del dibujo
        32 // alto del dibujo);
      );
    }

    function playerMovement() {
      let nextPlayerX = playerX;
      let nextPlayerY = playerY;

      const nextGridXRight = Math.floor((playerX + playerWidth + 2) / cellSize);
      const nextGridXLeft = Math.floor((playerX - 1) / cellSize);
      const nextGridYUp = Math.floor((playerY - 1) / cellSize);
      const nextGridYDown = Math.floor((playerY + playerHeight + 2) / cellSize);

      if (rightPressed && playerX < canvas.width - playerWidth - cellSize) {
        if (
          canMoveTo(nextGridXRight, Math.floor(playerY / cellSize)) &&
          canMoveTo(
            nextGridXRight,
            Math.floor((playerY + playerHeight - 1) / cellSize)
          )
        ) {
          nextPlayerX += PLAYER_SENSITIVITY;
        }
      } else if (leftPressed && playerX > cellSize) {
        if (
          canMoveTo(nextGridXLeft, Math.floor(playerY / cellSize)) &&
          canMoveTo(
            nextGridXLeft,
            Math.floor((playerY + playerHeight - 1) / cellSize)
          )
        ) {
          nextPlayerX -= PLAYER_SENSITIVITY;
        }
      } else if (upPressed && playerY > cellSize) {
        if (
          canMoveTo(Math.floor(playerX / cellSize), nextGridYUp) &&
          canMoveTo(
            Math.floor((playerX + playerWidth - 1) / cellSize),
            nextGridYUp
          )
        ) {
          nextPlayerY -= PLAYER_SENSITIVITY;
        }
      } else if (
        downPressed &&
        playerY < canvas.height - playerHeight - cellSize
      ) {
        if (
          canMoveTo(Math.floor(playerX / cellSize), nextGridYDown) &&
          canMoveTo(
            Math.floor((playerX + playerWidth - 1) / cellSize),
            nextGridYDown
          )
        ) {
          nextPlayerY += PLAYER_SENSITIVITY;
        }
      }

      if (!isCollidingWithObstacle(nextPlayerX, nextPlayerY)) {
        playerX = nextPlayerX;
        playerY = nextPlayerY;
      }
    }

    function canMoveTo(gridX, gridY) {
      return map[gridY][gridX] !== 1 && map[gridY][gridX] !== 2;
    }

    function isCollidingWithObstacle(x, y) {
      const i = Math.floor(y / cellSize);
      const j = Math.floor(x / cellSize);
      return map[i][j] === 1 || map[i][j] === 2;
    }

    // LIMPIAR EL CANVAS
    function cleanCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    // INICIAR EVENTOS
    function initEvents() {
      document.addEventListener("keydown", keyDownHandler);
      document.addEventListener("keyup", keyUpHandler);

      function keyDownHandler(event) {
        const { key } = event;
        if (
          key === "Right" ||
          key === "ArrowRight" ||
          key.toLowerCase() === "d"
        ) {
          rightPressed = true;
        } else if (
          key === "Left" ||
          key === "ArrowLeft" ||
          key.toLowerCase() === "a"
        ) {
          leftPressed = true;
        } else if (
          key === "Up" ||
          key === "ArrowUp" ||
          key.toLowerCase() === "w"
        ) {
          upPressed = true;
        } else if (
          key === "Down" ||
          key === "ArrowDown" ||
          key.toLowerCase() === "s"
        ) {
          downPressed = true;
        }
      }

      function keyUpHandler(event) {
        const { key } = event;
        if (
          key === "Right" ||
          key === "ArrowRight" ||
          key.toLowerCase() === "d"
        ) {
          rightPressed = false;
        } else if (
          key === "Left" ||
          key === "ArrowLeft" ||
          key.toLowerCase() === "a"
        ) {
          leftPressed = false;
        } else if (
          key === "Up" ||
          key === "ArrowUp" ||
          key.toLowerCase() === "w"
        ) {
          upPressed = false;
        } else if (
          key === "Down" ||
          key === "ArrowDown" ||
          key.toLowerCase() === "s"
        ) {
          downPressed = false;
        }
      }
    }

    // a que velocidad de fps queremos que renderice nuestro juego
    const fps = 60;

    let msPrev = window.performance.now();
    let msFPSPrev = window.performance.now() + 1000;
    const msPerFrame = 1000 / fps;
    let frames = 0;
    let framesPerSec = fps;

    function draw() {
      window.requestAnimationFrame(draw);

      const msNow = window.performance.now();
      const msPassed = msNow - msPrev;

      if (msPassed < msPerFrame) return;

      const excessTime = msPassed % msPerFrame;
      msPrev = msNow - excessTime;

      frames++;

      if (msFPSPrev < msNow) {
        msFPSPrev = window.performance.now() + 1000;
        framesPerSec = frames;
        frames = 0;
      }
      // Borrar el canvas
      cleanCanvas();

      // Dibujar el mapa y los elementos del juego
      drawMap();

      //Dibujar el jugador
      drawPlayer();

      playerMovement();
    }

    // Iniciar el bucle de juego
    draw();
    initEvents();
  </script>
</html>
